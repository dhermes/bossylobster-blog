---
title: `pow` Confusion
description: Losing a Whole Week to Exponentiation
date: 2020-11-25
author: Danny Hermes (dhermes@bossylobster.com)
tags: Math, Programming, Algorithms
slug: pow-confusion
comments: true
use_twitter_card: true
use_open_graph: true
use_schema_org: true
twitter_site: @bossylobster
twitter_creator: @bossylobster
social_image: images/fortran-exponent.png
github_slug: templated_content/2020-11-25-pow-confusion.template
---

In my first summer of graduate school my code suddenly stopped working
because Fortran and Python (via `pow()` in C) do exponentiation differently.
Once I debugged and understood the problem, I learned about the highly
optimized assembly code produced by Fortran for integer exponents.

To give a sample of the tool I wrote, here is an analysis of the assembly
generated by the `gfortran` compiler for `b = a**5`:

```text
$ python ./describe_assembly.py --exponent 5
+-------------------------+------------+
|        %xmm0[:64]       | %xmm1[:64] |
+-------------------------+------------+
|            a            |            | f2 0f 10 07     movsd   [(%rdi), %xmm0 ]
|            a            |     a      | 66 0f 28 c8     movapd  [ %xmm0, %xmm1 ]
|            a            |   a * a    | f2 0f 59 c8     mulsd   [ %xmm0, %xmm1 ]
|       (a * a) * a       |   a * a    | f2 0f 59 c1     mulsd   [ %xmm1, %xmm0 ]
| (a * a) * ((a * a) * a) |   a * a    | f2 0f 59 c1     mulsd   [ %xmm1, %xmm0 ]
|            b            |            | f2 0f 11 06     movsd   [ %xmm0, (%rsi)]
+-------------------------+------------+
```

### Contents

- [Motivation](#motivation)
- [What's the Difference?](#difference)
- [Fortran's Nifty Algorithm](#fortran-algorithm)
- [I Don't Speak Assembly](#assembly)

### Motivation {#motivation}

In my first summer of graduate school, I had a very productive June. I was
working on a research project[ref]The project unfortunately never led to
results that could be published.[/ref] on optimization of triangular meshes for
compression and storage. A core part of this involved taking fourth powers of
floating point numbers[ref]I.e., values of type `double` in C[/ref]. Once I
reached a point where my slow Python code worked well enough, I started porting
to Fortran 95. I foolishly expected bit-for-bit identical behavior but instead
the changes &mdash; which I later learned were exclusively from the fourth
power operation &mdash; were so dramatic I lost a **full week** of productivity
debugging the existing test cases.

As with most optimization problems, this involved applying
[gradient descent][1][ref]and related algorithms[/ref] to a number of
handpicked objective functions. Since this involved triangles and compression,
we were trying to modify the mesh[ref]It's worth noting that for our purposes a
[trianglular mesh][2] is just a collection of triangles that share edges, so if
one triangle changes, the neighboring triangles must as well.[/ref] by
"binning" triangles into similar shapes. For our early objective functions,
this could lead to flattened out triangles that looked more like lines than
triangles. Luckily there [exist][3] a number of ways to measure the "quality"
<html-literal>3c7370616e20636c6173733d226b61746578223e3c7370616e20636c6173733d226b617465782d6d6174686d6c223e3c6d6174683e3c73656d616e746963733e3c6d726f773e3c6d693e713c2f6d693e3c2f6d726f773e3c616e6e6f746174696f6e20656e636f64696e673d226170706c69636174696f6e2f782d746578223e713c2f616e6e6f746174696f6e3e3c2f73656d616e746963733e3c2f6d6174683e3c2f7370616e3e3c7370616e20636c6173733d226b617465782d68746d6c2220617269612d68696464656e3d2274727565223e3c7370616e20636c6173733d2262617365223e3c7370616e20636c6173733d22737472757422207374796c653d226865696768743a302e363235656d3b766572746963616c2d616c69676e3a2d302e3139343434656d3b223e3c2f7370616e3e3c7370616e20636c6173733d226d6f7264206d617468697422207374796c653d226d617267696e2d72696768743a302e3033353838656d3b223e713c2f7370616e3e3c2f7370616e3e3c2f7370616e3e3c2f7370616e3e</html-literal> of a triangle as a number between <html-literal>3c7370616e20636c6173733d226b61746578223e3c7370616e20636c6173733d226b617465782d6d6174686d6c223e3c6d6174683e3c73656d616e746963733e3c6d726f773e3c6d6e3e303c2f6d6e3e3c2f6d726f773e3c616e6e6f746174696f6e20656e636f64696e673d226170706c69636174696f6e2f782d746578223e303c2f616e6e6f746174696f6e3e3c2f73656d616e746963733e3c2f6d6174683e3c2f7370616e3e3c7370616e20636c6173733d226b617465782d68746d6c2220617269612d68696464656e3d2274727565223e3c7370616e20636c6173733d2262617365223e3c7370616e20636c6173733d22737472757422207374796c653d226865696768743a302e3634343434656d3b766572746963616c2d616c69676e3a30656d3b223e3c2f7370616e3e3c7370616e20636c6173733d226d6f7264223e303c2f7370616e3e3c2f7370616e3e3c2f7370616e3e3c2f7370616e3e</html-literal> and
<html-literal>3c7370616e20636c6173733d226b61746578223e3c7370616e20636c6173733d226b617465782d6d6174686d6c223e3c6d6174683e3c73656d616e746963733e3c6d726f773e3c6d6e3e313c2f6d6e3e3c2f6d726f773e3c616e6e6f746174696f6e20656e636f64696e673d226170706c69636174696f6e2f782d746578223e313c2f616e6e6f746174696f6e3e3c2f73656d616e746963733e3c2f6d6174683e3c2f7370616e3e3c7370616e20636c6173733d226b617465782d68746d6c2220617269612d68696464656e3d2274727565223e3c7370616e20636c6173733d2262617365223e3c7370616e20636c6173733d22737472757422207374796c653d226865696768743a302e3634343434656d3b766572746963616c2d616c69676e3a30656d3b223e3c2f7370616e3e3c7370616e20636c6173733d226d6f7264223e313c2f7370616e3e3c2f7370616e3e3c2f7370616e3e3c2f7370616e3e</html-literal>; a very low quality corresponds exactly
to this flatness. To penalize low-quality triangles we included functions of
<html-literal>3c7370616e20636c6173733d226b61746578223e3c7370616e20636c6173733d226b617465782d6d6174686d6c223e3c6d6174683e3c73656d616e746963733e3c6d726f773e3c6d6e3e313c2f6d6e3e3c6d69206d61746876617269616e743d226e6f726d616c223e2f3c2f6d693e3c6d693e713c2f6d693e3c2f6d726f773e3c616e6e6f746174696f6e20656e636f64696e673d226170706c69636174696f6e2f782d746578223e31202f20713c2f616e6e6f746174696f6e3e3c2f73656d616e746963733e3c2f6d6174683e3c2f7370616e3e3c7370616e20636c6173733d226b617465782d68746d6c2220617269612d68696464656e3d2274727565223e3c7370616e20636c6173733d2262617365223e3c7370616e20636c6173733d22737472757422207374796c653d226865696768743a31656d3b766572746963616c2d616c69676e3a2d302e3235656d3b223e3c2f7370616e3e3c7370616e20636c6173733d226d6f7264223e313c2f7370616e3e3c7370616e20636c6173733d226d6f7264223e2f3c2f7370616e3e3c7370616e20636c6173733d226d6f7264206d617468697422207374796c653d226d617267696e2d72696768743a302e3033353838656d3b223e713c2f7370616e3e3c2f7370616e3e3c2f7370616e3e3c2f7370616e3e</html-literal> in our objective functions and several of the most
successful used a loop over all triangles <html-literal>3c7370616e20636c6173733d226b61746578223e3c7370616e20636c6173733d226b617465782d6d6174686d6c223e3c6d6174683e3c73656d616e746963733e3c6d726f773e3c6d693e543c2f6d693e3c2f6d726f773e3c616e6e6f746174696f6e20656e636f64696e673d226170706c69636174696f6e2f782d746578223e543c2f616e6e6f746174696f6e3e3c2f73656d616e746963733e3c2f6d6174683e3c2f7370616e3e3c7370616e20636c6173733d226b617465782d68746d6c2220617269612d68696464656e3d2274727565223e3c7370616e20636c6173733d2262617365223e3c7370616e20636c6173733d22737472757422207374796c653d226865696768743a302e3638333333656d3b766572746963616c2d616c69676e3a30656d3b223e3c2f7370616e3e3c7370616e20636c6173733d226d6f7264206d617468697422207374796c653d226d617267696e2d72696768743a302e3133383839656d3b223e543c2f7370616e3e3c2f7370616e3e3c2f7370616e3e3c2f7370616e3e</html-literal> in the mesh
<html-literal>3c7370616e20636c6173733d226b61746578223e3c7370616e20636c6173733d226b617465782d6d6174686d6c223e3c6d6174683e3c73656d616e746963733e3c6d726f773e3c6d69206d61746876617269616e743d22736372697074223e4d3c2f6d693e3c2f6d726f773e3c616e6e6f746174696f6e20656e636f64696e673d226170706c69636174696f6e2f782d746578223e5c6d61746863616c7b4d7d3c2f616e6e6f746174696f6e3e3c2f73656d616e746963733e3c2f6d6174683e3c2f7370616e3e3c7370616e20636c6173733d226b617465782d68746d6c2220617269612d68696464656e3d2274727565223e3c7370616e20636c6173733d2262617365223e3c7370616e20636c6173733d22737472757422207374796c653d226865696768743a302e3638333333656d3b766572746963616c2d616c69676e3a30656d3b223e3c2f7370616e3e3c7370616e20636c6173733d226d6f7264223e3c7370616e20636c6173733d226d6f7264206d61746863616c223e4d3c2f7370616e3e3c2f7370616e3e3c2f7370616e3e3c2f7370616e3e3c2f7370616e3e</html-literal>

<div class="katex-elt"><blockquote>
<html-literal>3c7370616e20636c6173733d226b617465782d646973706c6179223e3c7370616e20636c6173733d226b61746578223e3c7370616e20636c6173733d226b617465782d6d6174686d6c223e3c6d6174683e3c73656d616e746963733e3c6d726f773e3c6d756e6465723e3c6d6f3e2623383732313b3c2f6d6f3e3c6d726f773e3c6d693e543c2f6d693e3c6d6f3e2623383731323b3c2f6d6f3e3c6d69206d61746876617269616e743d22736372697074223e4d3c2f6d693e3c2f6d726f773e3c2f6d756e6465723e3c6d667261633e3c6d6e3e313c2f6d6e3e3c6d726f773e3c6d693e713c2f6d693e3c6d6f3e283c2f6d6f3e3c6d693e543c2f6d693e3c6d7375703e3c6d6f3e293c2f6d6f3e3c6d6e3e343c2f6d6e3e3c2f6d7375703e3c2f6d726f773e3c2f6d667261633e3c2f6d726f773e3c616e6e6f746174696f6e20656e636f64696e673d226170706c69636174696f6e2f782d746578223e5c73756d5f7b54205c696e205c6d61746863616c7b4d7d7d205c667261637b317d7b712854295e347d3c2f616e6e6f746174696f6e3e3c2f73656d616e746963733e3c2f6d6174683e3c2f7370616e3e3c7370616e20636c6173733d226b617465782d68746d6c2220617269612d68696464656e3d2274727565223e3c7370616e20636c6173733d2262617365223e3c7370616e20636c6173733d22737472757422207374796c653d226865696768743a322e36343331343539393939393939393938656d3b766572746963616c2d616c69676e3a2d312e333231373036656d3b223e3c2f7370616e3e3c7370616e20636c6173733d226d6f70206f702d6c696d697473223e3c7370616e20636c6173733d22766c6973742d7420766c6973742d7432223e3c7370616e20636c6173733d22766c6973742d72223e3c7370616e20636c6173733d22766c69737422207374796c653d226865696768743a312e303530303035656d3b223e3c7370616e207374796c653d22746f703a2d312e38353536363339393939393939393938656d3b6d617267696e2d6c6566743a30656d3b223e3c7370616e20636c6173733d2270737472757422207374796c653d226865696768743a332e3035656d3b223e3c2f7370616e3e3c7370616e20636c6173733d2273697a696e672072657365742d73697a65362073697a6533206d7469676874223e3c7370616e20636c6173733d226d6f7264206d7469676874223e3c7370616e20636c6173733d226d6f7264206d6174686974206d746967687422207374796c653d226d617267696e2d72696768743a302e3133383839656d3b223e543c2f7370616e3e3c7370616e20636c6173733d226d72656c206d7469676874223e2623383731323b3c2f7370616e3e3c7370616e20636c6173733d226d6f7264206d7469676874223e3c7370616e20636c6173733d226d6f7264206d61746863616c206d7469676874223e4d3c2f7370616e3e3c2f7370616e3e3c2f7370616e3e3c2f7370616e3e3c2f7370616e3e3c7370616e207374796c653d22746f703a2d332e30353030303439393939393939393936656d3b223e3c7370616e20636c6173733d2270737472757422207374796c653d226865696768743a332e3035656d3b223e3c2f7370616e3e3c7370616e3e3c7370616e20636c6173733d226d6f70206f702d73796d626f6c206c617267652d6f70223e2623383732313b3c2f7370616e3e3c2f7370616e3e3c2f7370616e3e3c2f7370616e3e3c7370616e20636c6173733d22766c6973742d73223e2623383230333b3c2f7370616e3e3c2f7370616e3e3c7370616e20636c6173733d22766c6973742d72223e3c7370616e20636c6173733d22766c69737422207374796c653d226865696768743a312e333231373036656d3b223e3c7370616e3e3c2f7370616e3e3c2f7370616e3e3c2f7370616e3e3c2f7370616e3e3c2f7370616e3e3c7370616e20636c6173733d226d737061636522207374796c653d226d617267696e2d72696768743a302e3136363636363636363636363636363636656d3b223e3c2f7370616e3e3c7370616e20636c6173733d226d6f7264223e3c7370616e20636c6173733d226d6f70656e206e756c6c64656c696d69746572223e3c2f7370616e3e3c7370616e20636c6173733d226d66726163223e3c7370616e20636c6173733d22766c6973742d7420766c6973742d7432223e3c7370616e20636c6173733d22766c6973742d72223e3c7370616e20636c6173733d22766c69737422207374796c653d226865696768743a312e3332313434656d3b223e3c7370616e207374796c653d22746f703a2d322e333134656d3b223e3c7370616e20636c6173733d2270737472757422207374796c653d226865696768743a33656d3b223e3c2f7370616e3e3c7370616e20636c6173733d226d6f7264223e3c7370616e20636c6173733d226d6f7264206d617468697422207374796c653d226d617267696e2d72696768743a302e3033353838656d3b223e713c2f7370616e3e3c7370616e20636c6173733d226d6f70656e223e283c2f7370616e3e3c7370616e20636c6173733d226d6f7264206d617468697422207374796c653d226d617267696e2d72696768743a302e3133383839656d3b223e543c2f7370616e3e3c7370616e20636c6173733d226d636c6f7365223e3c7370616e20636c6173733d226d636c6f7365223e293c2f7370616e3e3c7370616e20636c6173733d226d737570737562223e3c7370616e20636c6173733d22766c6973742d74223e3c7370616e20636c6173733d22766c6973742d72223e3c7370616e20636c6173733d22766c69737422207374796c653d226865696768743a302e373430313038656d3b223e3c7370616e207374796c653d22746f703a2d322e39383930303030303030303030303033656d3b6d617267696e2d72696768743a302e3035656d3b223e3c7370616e20636c6173733d2270737472757422207374796c653d226865696768743a322e37656d3b223e3c2f7370616e3e3c7370616e20636c6173733d2273697a696e672072657365742d73697a65362073697a6533206d7469676874223e3c7370616e20636c6173733d226d6f7264206d7469676874223e343c2f7370616e3e3c2f7370616e3e3c2f7370616e3e3c2f7370616e3e3c2f7370616e3e3c2f7370616e3e3c2f7370616e3e3c2f7370616e3e3c2f7370616e3e3c2f7370616e3e3c7370616e207374796c653d22746f703a2d332e3233656d3b223e3c7370616e20636c6173733d2270737472757422207374796c653d226865696768743a33656d3b223e3c2f7370616e3e3c7370616e20636c6173733d22667261632d6c696e6522207374796c653d22626f726465722d626f74746f6d2d77696474683a302e3034656d3b223e3c2f7370616e3e3c2f7370616e3e3c7370616e207374796c653d22746f703a2d332e363737656d3b223e3c7370616e20636c6173733d2270737472757422207374796c653d226865696768743a33656d3b223e3c2f7370616e3e3c7370616e20636c6173733d226d6f7264223e3c7370616e20636c6173733d226d6f7264223e313c2f7370616e3e3c2f7370616e3e3c2f7370616e3e3c2f7370616e3e3c7370616e20636c6173733d22766c6973742d73223e2623383230333b3c2f7370616e3e3c2f7370616e3e3c7370616e20636c6173733d22766c6973742d72223e3c7370616e20636c6173733d22766c69737422207374796c653d226865696768743a302e393336656d3b223e3c7370616e3e3c2f7370616e3e3c2f7370616e3e3c2f7370616e3e3c2f7370616e3e3c2f7370616e3e3c7370616e20636c6173733d226d636c6f7365206e756c6c64656c696d69746572223e3c2f7370616e3e3c2f7370616e3e3c2f7370616e3e3c2f7370616e3e3c2f7370616e3e3c2f7370616e3e</html-literal>
</blockquote></div>

### What's the Difference? {#difference}

When the exponent `n` is an integer, Fortran `x**n` behaves
much differently than Python. In Fortran, optimized assembly is generated to
minimize the number of multiplications, whereas Python calls out to `pow()`
from `math.h` in C. Compare an explicit vs. implicit implementation in Python:

```python
def fourth_explicit(value):
    squared = value * value
    return squared * squared


def fourth_pow(value):
    return value ** 4
```

For well-behaved values, these two functions compute
<html-literal>3c7370616e20636c6173733d226b61746578223e3c7370616e20636c6173733d226b617465782d6d6174686d6c223e3c6d6174683e3c73656d616e746963733e3c6d726f773e3c6d6e3e313c2f6d6e3e3c6d69206d61746876617269616e743d226e6f726d616c223e2f3c2f6d693e3c6d7375703e3c6d693e713c2f6d693e3c6d6e3e343c2f6d6e3e3c2f6d7375703e3c2f6d726f773e3c616e6e6f746174696f6e20656e636f64696e673d226170706c69636174696f6e2f782d746578223e31202f20715e343c2f616e6e6f746174696f6e3e3c2f73656d616e746963733e3c2f6d6174683e3c2f7370616e3e3c7370616e20636c6173733d226b617465782d68746d6c2220617269612d68696464656e3d2274727565223e3c7370616e20636c6173733d2262617365223e3c7370616e20636c6173733d22737472757422207374796c653d226865696768743a312e303634313038656d3b766572746963616c2d616c69676e3a2d302e3235656d3b223e3c2f7370616e3e3c7370616e20636c6173733d226d6f7264223e313c2f7370616e3e3c7370616e20636c6173733d226d6f7264223e2f3c2f7370616e3e3c7370616e20636c6173733d226d6f7264223e3c7370616e20636c6173733d226d6f7264206d617468697422207374796c653d226d617267696e2d72696768743a302e3033353838656d3b223e713c2f7370616e3e3c7370616e20636c6173733d226d737570737562223e3c7370616e20636c6173733d22766c6973742d74223e3c7370616e20636c6173733d22766c6973742d72223e3c7370616e20636c6173733d22766c69737422207374796c653d226865696768743a302e38313431303739393939393939393939656d3b223e3c7370616e207374796c653d22746f703a2d332e303633656d3b6d617267696e2d72696768743a302e3035656d3b223e3c7370616e20636c6173733d2270737472757422207374796c653d226865696768743a322e37656d3b223e3c2f7370616e3e3c7370616e20636c6173733d2273697a696e672072657365742d73697a65362073697a6533206d7469676874223e3c7370616e20636c6173733d226d6f7264206d7469676874223e343c2f7370616e3e3c2f7370616e3e3c2f7370616e3e3c2f7370616e3e3c2f7370616e3e3c2f7370616e3e3c2f7370616e3e3c2f7370616e3e3c2f7370616e3e3c2f7370616e3e3c2f7370616e3e</html-literal> without much difference

```python
>>> 1 / fourth_explicit(0.25)
256.0
>>> 1 / fourth_pow(0.25)
256.0
>>> quality = 0.2689565746627065
>>> 1 / fourth_explicit(quality)
191.1046874202122
>>> 1 / fourth_pow(quality)
191.10468742021223
```

however when <html-literal>3c7370616e20636c6173733d226b61746578223e3c7370616e20636c6173733d226b617465782d6d6174686d6c223e3c6d6174683e3c73656d616e746963733e3c6d726f773e3c6d693e713c2f6d693e3c2f6d726f773e3c616e6e6f746174696f6e20656e636f64696e673d226170706c69636174696f6e2f782d746578223e713c2f616e6e6f746174696f6e3e3c2f73656d616e746963733e3c2f6d6174683e3c2f7370616e3e3c7370616e20636c6173733d226b617465782d68746d6c2220617269612d68696464656e3d2274727565223e3c7370616e20636c6173733d2262617365223e3c7370616e20636c6173733d22737472757422207374796c653d226865696768743a302e363235656d3b766572746963616c2d616c69676e3a2d302e3139343434656d3b223e3c2f7370616e3e3c7370616e20636c6173733d226d6f7264206d617468697422207374796c653d226d617267696e2d72696768743a302e3033353838656d3b223e713c2f7370616e3e3c2f7370616e3e3c2f7370616e3e3c2f7370616e3e</html-literal> becomes small (the type of values we are
penalizing) the magnitude of <html-literal>3c7370616e20636c6173733d226b61746578223e3c7370616e20636c6173733d226b617465782d6d6174686d6c223e3c6d6174683e3c73656d616e746963733e3c6d726f773e3c6d6e3e313c2f6d6e3e3c6d69206d61746876617269616e743d226e6f726d616c223e2f3c2f6d693e3c6d7375703e3c6d693e713c2f6d693e3c6d6e3e343c2f6d6e3e3c2f6d7375703e3c2f6d726f773e3c616e6e6f746174696f6e20656e636f64696e673d226170706c69636174696f6e2f782d746578223e31202f20715e343c2f616e6e6f746174696f6e3e3c2f73656d616e746963733e3c2f6d6174683e3c2f7370616e3e3c7370616e20636c6173733d226b617465782d68746d6c2220617269612d68696464656e3d2274727565223e3c7370616e20636c6173733d2262617365223e3c7370616e20636c6173733d22737472757422207374796c653d226865696768743a312e303634313038656d3b766572746963616c2d616c69676e3a2d302e3235656d3b223e3c2f7370616e3e3c7370616e20636c6173733d226d6f7264223e313c2f7370616e3e3c7370616e20636c6173733d226d6f7264223e2f3c2f7370616e3e3c7370616e20636c6173733d226d6f7264223e3c7370616e20636c6173733d226d6f7264206d617468697422207374796c653d226d617267696e2d72696768743a302e3033353838656d3b223e713c2f7370616e3e3c7370616e20636c6173733d226d737570737562223e3c7370616e20636c6173733d22766c6973742d74223e3c7370616e20636c6173733d22766c6973742d72223e3c7370616e20636c6173733d22766c69737422207374796c653d226865696768743a302e38313431303739393939393939393939656d3b223e3c7370616e207374796c653d22746f703a2d332e303633656d3b6d617267696e2d72696768743a302e3035656d3b223e3c7370616e20636c6173733d2270737472757422207374796c653d226865696768743a322e37656d3b223e3c2f7370616e3e3c7370616e20636c6173733d2273697a696e672072657365742d73697a65362073697a6533206d7469676874223e3c7370616e20636c6173733d226d6f7264206d7469676874223e343c2f7370616e3e3c2f7370616e3e3c2f7370616e3e3c2f7370616e3e3c2f7370616e3e3c2f7370616e3e3c2f7370616e3e3c2f7370616e3e3c2f7370616e3e3c2f7370616e3e3c2f7370616e3e</html-literal> means that small
relative differences are still large absolute differences in our objective
function:

```python
>>> quality = 2.3824755061912883e-06
>>> 1 / fourth_explicit(quality)
3.103746353229757e+22
>>> 1 / fourth_pow(quality)
3.103746353229758e+22
>>>
>>> 1 / fourth_explicit(quality) - 1 / fourth_pow(quality)
-8388608.0
```

The difference is caused by the fact that `pow()` treats everything like a
floating point number and uses `exp()`, `log()` and multiplication via

<div class="katex-elt"><blockquote>
<html-literal>3c7370616e20636c6173733d226b617465782d646973706c6179223e3c7370616e20636c6173733d226b61746578223e3c7370616e20636c6173733d226b617465782d6d6174686d6c223e3c6d6174683e3c73656d616e746963733e3c6d726f773e3c6d7375703e3c6d693e783c2f6d693e3c6d693e793c2f6d693e3c2f6d7375703e3c6d6f3e3d3c2f6d6f3e3c6d7375703e3c6d693e653c2f6d693e3c6d726f773e3c6d693e793c2f6d693e3c6d693e6c6f673c2f6d693e3c6d6f3e2623383238393b3c2f6d6f3e3c6d6f3e283c2f6d6f3e3c6d693e783c2f6d693e3c6d6f3e293c2f6d6f3e3c2f6d726f773e3c2f6d7375703e3c6d69206d61746876617269616e743d226e6f726d616c223e2e3c2f6d693e3c2f6d726f773e3c616e6e6f746174696f6e20656e636f64696e673d226170706c69636174696f6e2f782d746578223e785e79203d20655e7b79205c6c6f672878297d2e3c2f616e6e6f746174696f6e3e3c2f73656d616e746963733e3c2f6d6174683e3c2f7370616e3e3c7370616e20636c6173733d226b617465782d68746d6c2220617269612d68696464656e3d2274727565223e3c7370616e20636c6173733d2262617365223e3c7370616e20636c6173733d22737472757422207374796c653d226865696768743a302e373134333932656d3b766572746963616c2d616c69676e3a30656d3b223e3c2f7370616e3e3c7370616e20636c6173733d226d6f7264223e3c7370616e20636c6173733d226d6f7264206d6174686974223e783c2f7370616e3e3c7370616e20636c6173733d226d737570737562223e3c7370616e20636c6173733d22766c6973742d74223e3c7370616e20636c6173733d22766c6973742d72223e3c7370616e20636c6173733d22766c69737422207374796c653d226865696768743a302e373134333932656d3b223e3c7370616e207374796c653d22746f703a2d332e31313330303030303030303030303034656d3b6d617267696e2d72696768743a302e3035656d3b223e3c7370616e20636c6173733d2270737472757422207374796c653d226865696768743a322e37656d3b223e3c2f7370616e3e3c7370616e20636c6173733d2273697a696e672072657365742d73697a65362073697a6533206d7469676874223e3c7370616e20636c6173733d226d6f7264206d6174686974206d746967687422207374796c653d226d617267696e2d72696768743a302e3033353838656d3b223e793c2f7370616e3e3c2f7370616e3e3c2f7370616e3e3c2f7370616e3e3c2f7370616e3e3c2f7370616e3e3c2f7370616e3e3c2f7370616e3e3c7370616e20636c6173733d226d737061636522207374796c653d226d617267696e2d72696768743a302e32373737373737373737373737373738656d3b223e3c2f7370616e3e3c7370616e20636c6173733d226d72656c223e3d3c2f7370616e3e3c7370616e20636c6173733d226d737061636522207374796c653d226d617267696e2d72696768743a302e32373737373737373737373737373738656d3b223e3c2f7370616e3e3c2f7370616e3e3c7370616e20636c6173733d2262617365223e3c7370616e20636c6173733d22737472757422207374796c653d226865696768743a302e393338656d3b766572746963616c2d616c69676e3a30656d3b223e3c2f7370616e3e3c7370616e20636c6173733d226d6f7264223e3c7370616e20636c6173733d226d6f7264206d6174686974223e653c2f7370616e3e3c7370616e20636c6173733d226d737570737562223e3c7370616e20636c6173733d22766c6973742d74223e3c7370616e20636c6173733d22766c6973742d72223e3c7370616e20636c6173733d22766c69737422207374796c653d226865696768743a302e393338656d3b223e3c7370616e207374796c653d22746f703a2d332e313133656d3b6d617267696e2d72696768743a302e3035656d3b223e3c7370616e20636c6173733d2270737472757422207374796c653d226865696768743a322e37656d3b223e3c2f7370616e3e3c7370616e20636c6173733d2273697a696e672072657365742d73697a65362073697a6533206d7469676874223e3c7370616e20636c6173733d226d6f7264206d7469676874223e3c7370616e20636c6173733d226d6f7264206d6174686974206d746967687422207374796c653d226d617267696e2d72696768743a302e3033353838656d3b223e793c2f7370616e3e3c7370616e20636c6173733d226d7370616365206d746967687422207374796c653d226d617267696e2d72696768743a302e3139353136363636363636363636363638656d3b223e3c2f7370616e3e3c7370616e20636c6173733d226d6f70206d7469676874223e6c6f3c7370616e207374796c653d226d617267696e2d72696768743a302e3031333839656d3b223e673c2f7370616e3e3c2f7370616e3e3c7370616e20636c6173733d226d6f70656e206d7469676874223e283c2f7370616e3e3c7370616e20636c6173733d226d6f7264206d6174686974206d7469676874223e783c2f7370616e3e3c7370616e20636c6173733d226d636c6f7365206d7469676874223e293c2f7370616e3e3c2f7370616e3e3c2f7370616e3e3c2f7370616e3e3c2f7370616e3e3c2f7370616e3e3c2f7370616e3e3c2f7370616e3e3c2f7370616e3e3c7370616e20636c6173733d226d6f7264223e2e3c2f7370616e3e3c2f7370616e3e3c2f7370616e3e3c2f7370616e3e3c2f7370616e3e</html-literal>
</blockquote></div>

### Fortran's Nifty Algorithm {#fortran-algorithm}

Breaking down the [assembly][4] for `b = a**4` in Fortran we see the repeated
squaring

```asm
pow4:
  movsd xmm0, QWORD PTR [rdi]
  mulsd xmm0, xmm0
  mulsd xmm0, xmm0
  movsd QWORD PTR [rsi], xmm0
  ret
```

as compared to a jump (`jmp`) instruction [in C][6]

```asm
pow4:
  movsd xmm1, QWORD PTR .LC0[rip]
  jmp pow
.LC0:
  .long 0
  .long 1074790400
```

Similarly for `q**7` the assembly [shows][5] only multiplications (vs. a `jmp`)

```asm
pow7:
  movsd xmm0, QWORD PTR [rdi]
  movapd xmm1, xmm0
  mulsd xmm1, xmm0
  mulsd xmm0, xmm1
  mulsd xmm1, xmm1
  mulsd xmm0, xmm1
  movsd QWORD PTR [rsi], xmm0
  ret
```

### I Don't Speak Assembly {#assembly}

Like most professional software engineers (and science PhDs who write code) I
have no formal training, so reading assembly is never something I've done.
So I wrote a [script][7] to generate a Fortran subroutine that computes
`b = a**n` for a fixed value of `n`, compiles the code to an object file
and then disassembles it. For example:

```text
$ gfortran -c -O3 ./pow7.f90 -o ./pow7.o -J ./
$ objdump --disassemble ./pow7.o
```

However, these instructions are still hard to visualize so I parsed the
disassembled instructions from the object file and tracked all of the
active registers (`%xmm{N}`) as they were updated. In addition to the `xmm`
registers, the `%rsi` (source) and `%rdi` (destination) registers are used
for copying data **from** `a` and **to** `b` after the computation is done.

Being able to visualize this really helped! For `n = 4` we can see the
generated assembly is efficient enough that it only requires one register

```text
$ python ./describe_assembly.py --exponent 4
+-------------------+
|     %xmm0[:64]    |
+-------------------+
|         a         | f2 0f 10 07     movsd   [(%rdi), %xmm0 ]
|       a * a       | f2 0f 59 c0     mulsd   [ %xmm0, %xmm0 ]
| (a * a) * (a * a) | f2 0f 59 c0     mulsd   [ %xmm0, %xmm0 ]
|         b         | f2 0f 11 06     movsd   [ %xmm0, (%rsi)]
+-------------------+
```

and `n = 7` can do all of its work in two registers

```text
$ python ./describe_assembly.py --exponent 7
+-------------------------------------+-------------------+
|              %xmm0[:64]             |     %xmm1[:64]    |
+-------------------------------------+-------------------+
|                  a                  |                   | f2 0f 10 07     movsd   [(%rdi), %xmm0 ]
|                  a                  |         a         | 66 0f 28 c8     movapd  [ %xmm0, %xmm1 ]
|                  a                  |       a * a       | f2 0f 59 c8     mulsd   [ %xmm0, %xmm1 ]
|             (a * a) * a             |       a * a       | f2 0f 59 c1     mulsd   [ %xmm1, %xmm0 ]
|             (a * a) * a             | (a * a) * (a * a) | f2 0f 59 c9     mulsd   [ %xmm1, %xmm1 ]
| ((a * a) * (a * a)) * ((a * a) * a) | (a * a) * (a * a) | f2 0f 59 c1     mulsd   [ %xmm1, %xmm0 ]
|                  b                  |                   | f2 0f 11 06     movsd   [ %xmm0, (%rsi)]
+-------------------------------------+-------------------+
```

> **PS**: It's worth noting here that black box analysis of the generated
> assembly is not the only way to understand what `gfortran` will do. I
> attempted to dive into the source for `gfortran` to understand exactly how
> this is generated (in particular if it differs when the exponent `n` is not
> known until runtime). However, I was not able to find any conclusive section
> of code responsible and ran out of time digging.

[1]: https://en.wikipedia.org/wiki/Gradient_descent
[2]: https://en.wikipedia.org/wiki/Triangle_mesh
[3]: https://doi.org/10.1090/S0025-5718-03-01485-6
[4]: https://godbolt.org/z/eq6MGh
[5]: https://godbolt.org/z/f7EPWP
[6]: https://godbolt.org/z/b5nYed
[7]: /code/describe_assembly.py
